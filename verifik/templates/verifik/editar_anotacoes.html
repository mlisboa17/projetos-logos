{% extends 'verifik/base.html' %}

{% block title %}Editar Anota√ß√µes - VerifiK{% endblock %}

{% block content %}
<style>
    /* Layout Responsivo para Resolu√ß√£o Baixa */
    .anotacao-layout {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .painel-lateral {
        flex: 0 0 280px;
        min-width: 280px;
    }
    
    .area-anotacao {
        flex: 1;
        min-width: 500px;
    }
    
    /* Otimiza√ß√£o para 1360x768 e resolu√ß√µes similares */
    @media (max-width: 1400px) {
        .anotacao-layout {
            flex-direction: column;
        }
        
        .painel-lateral {
            flex: none;
            width: 100%;
            order: 2;
        }
        
        .area-anotacao {
            flex: none;
            width: 100%;
            order: 1;
            min-width: auto;
        }
        
        .container-fluid {
            margin: 0.5rem auto !important;
            padding: 0 0.25rem !important;
        }
        
        .card {
            padding: 1rem !important;
        }
    }
    
    /* Otimiza√ß√£o espec√≠fica para 1360x768 */
    @media (max-width: 1360px) and (max-height: 768px) {
        .container-fluid {
            margin: 0.25rem auto !important;
        }
        
        .card {
            padding: 0.75rem !important;
            border-radius: 8px !important;
        }
        
        h2 {
            font-size: 1.25rem !important;
            margin-bottom: 0.75rem !important;
        }
        
        h3 {
            font-size: 1.1rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* Bot√µes mais compactos */
        .btn-acao {
            padding: 0.5rem 1rem !important;
            font-size: 0.9rem !important;
        }
        
        /* Painel lateral mais compacto */
        .produtos-grid {
            max-height: 200px;
            overflow-y: auto;
        }
    }

    #canvas-container {
        position: relative;
        display: inline-block;
        max-width: 100%;
        margin: 0 auto;
    }
    
    #image-canvas {
        max-width: 100%;
        max-height: 70vh;
        border: 2px solid #667eea;
        border-radius: 8px;
        cursor: crosshair;
        display: block;
    }
    
    .bbox {
        position: absolute;
        border: 3px solid #667eea;
        background: rgba(102, 126, 234, 0.2);
        cursor: move;
        box-sizing: border-box;
    }
    
    .bbox-label {
        position: absolute;
        background: #667eea;
        color: white;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 4px;
        top: -28px;
        left: 0;
        white-space: nowrap;
    }
    
    .bbox-remove {
        position: absolute;
        top: -28px;
        right: 0;
        background: #e74c3c;
        color: white;
        border: none;
        padding: 4px 8px;
        font-size: 11px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .bbox:hover {
        border-color: #764ba2;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
    }
    
    .produto-btn {
        padding: 0.75rem 1.5rem;
        margin: 0.25rem;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }
    
    .produto-btn:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }
    
    .produto-btn.active {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }
</style>

<div class="container-fluid" style="margin: 1rem auto; padding: 0 0.5rem;">
    <div class="anotacao-layout">
        
        <!-- Painel Lateral -->
        <div class="painel-lateral">
            <div class="card" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 1.5rem;">
                <h3 style="color: #667eea; margin-bottom: 1rem;">üéØ Ferramentas</h3>
                
                <!-- Status -->
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 0.5rem;">Status</div>
                    <div style="font-weight: 600; color: #2c3e50;">
                        {% if imagem.status == 'anotando' %}
                            üìù Em Anota√ß√£o
                        {% elif imagem.status == 'concluida' %}
                            ‚úì Conclu√≠da
                        {% elif imagem.status == 'aprovada' %}
                            ‚úì Aprovada
                        {% endif %}
                    </div>
                </div>
                
                <!-- Contador -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;" id="counter">{{ imagem.total_anotacoes }}</div>
                    <div style="opacity: 0.9; font-size: 0.9rem;">Produtos Anotados</div>
                </div>
                
                <!-- Instru√ß√µes -->
                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid #f39c12; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; color: #856404; margin-bottom: 0.5rem;">üìñ Como usar:</div>
                    <ol style="font-size: 0.85rem; color: #856404; margin: 0; padding-left: 1.2rem;">
                        <li>Selecione um produto abaixo</li>
                        <li>Clique e arraste na imagem para desenhar o box</li>
                        <li>Repita para cada produto</li>
                        <li>Clique em "Finalizar" quando terminar</li>
                    </ol>
                </div>
                
                <!-- Seletor de Produtos -->
                <h4 style="color: #2c3e50; margin-bottom: 0.75rem; font-size: 1rem;">Selecione o Produto:</h4>
                <div id="produto-selector" style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem;">
                    {% for produto in produtos %}
                    <button type="button" class="produto-btn" data-produto-id="{{ produto.id }}" data-produto-nome="{{ produto.descricao_produto }}" style="width: 100%; text-align: left; margin-bottom: 0.5rem;">
                        {{ produto.descricao_produto }}
                    </button>
                    {% endfor %}
                </div>
                
                <!-- A√ß√µes - Sempre Vis√≠veis -->
                <div class="acoes-fixas" style="position: sticky; bottom: 0; background: white; padding: 1rem 0; border-top: 2px solid #667eea; margin-top: 1rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        {% if imagem.status == 'anotando' %}
                        <form method="post" action="{% url 'finalizar_anotacao' imagem.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn-acao" style="width: 100%; padding: 1rem; background: #27ae60; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                ‚úì FINALIZAR ANOTA√á√ïES
                            </button>
                        </form>
                        
                        <!-- Bot√£o de Exportar Dataset -->
                        <a href="{% url 'exportar_dataset' imagem.id %}" class="btn-acao" style="width: 100%; padding: 1rem; background: #3498db; color: white; border: none; border-radius: 8px; text-align: center; text-decoration: none; font-weight: 700; font-size: 1.1rem; display: block; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                            üì• EXPORTAR DATASET
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'anotar_imagem' %}" class="btn-acao" style="width: 100%; padding: 1rem; background: #95a5a6; color: white; border: none; border-radius: 8px; text-align: center; text-decoration: none; font-weight: 700; font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                            ‚Üê VOLTAR
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- √Årea de Anota√ß√£o -->
        <div class="area-anotacao">
            <div class="card" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 2rem;">
                <h2 style="color: #667eea; margin-bottom: 1.5rem;">‚úèÔ∏è Marque os Produtos na Imagem</h2>
                
                <div id="canvas-container" style="text-align: center;">
                    <img id="image-canvas" src="{{ imagem.imagem.url }}" alt="Imagem para anotar">
                </div>
                
                <!-- Lista de Anota√ß√µes -->
                <div id="anotacoes-lista" style="margin-top: 1.5rem;">
                    <h3 style="color: #2c3e50; margin-bottom: 1rem;">üìã Anota√ß√µes Criadas</h3>
                    <div id="lista-items" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let produtoSelecionado = null;
let imagemId = {{ imagem.id }};
let anotacoes = {{ anotacoes_json|safe }};
let isDrawing = false;
let startX, startY;
let currentBox = null;

const canvas = document.getElementById('image-canvas');
const container = document.getElementById('canvas-container');
const counter = document.getElementById('counter');

// Configurar sele√ß√£o de produto
document.querySelectorAll('.produto-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.produto-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        produtoSelecionado = {
            id: this.dataset.produtoId,
            nome: this.dataset.produtoNome
        };
    });
});

// Desenhar bounding boxes existentes
function renderizarAnotacoes() {
    // Remover boxes antigos
    document.querySelectorAll('.bbox').forEach(el => el.remove());
    
    const rect = canvas.getBoundingClientRect();
    const imgWidth = canvas.naturalWidth;
    const imgHeight = canvas.naturalHeight;
    const displayWidth = rect.width;
    const displayHeight = rect.height;
    
    anotacoes.forEach((anotacao, index) => {
        criarBboxElement(anotacao, displayWidth, displayHeight);
    });
    
    // Atualizar lista
    atualizarLista();
}

function criarBboxElement(anotacao, displayWidth, displayHeight) {
    const bbox = document.createElement('div');
    bbox.className = 'bbox';
    bbox.dataset.anotacaoId = anotacao.id;
    
    // Converter coordenadas normalizadas para pixels
    const left = (anotacao.x - anotacao.width / 2) * displayWidth;
    const top = (anotacao.y - anotacao.height / 2) * displayHeight;
    const width = anotacao.width * displayWidth;
    const height = anotacao.height * displayHeight;
    
    bbox.style.left = left + 'px';
    bbox.style.top = top + 'px';
    bbox.style.width = width + 'px';
    bbox.style.height = height + 'px';
    
    // Label
    const label = document.createElement('div');
    label.className = 'bbox-label';
    label.textContent = anotacao.produto_nome;
    bbox.appendChild(label);
    
    // Bot√£o remover
    const removeBtn = document.createElement('button');
    removeBtn.className = 'bbox-remove';
    removeBtn.textContent = '‚úó';
    removeBtn.onclick = (e) => {
        e.stopPropagation();
        removerAnotacao(anotacao.id);
    };
    bbox.appendChild(removeBtn);
    
    container.appendChild(bbox);
}

function atualizarLista() {
    const lista = document.getElementById('lista-items');
    
    if (anotacoes.length === 0) {
        lista.innerHTML = '<div style="grid-column: 1/-1; color: #7f8c8d; text-align: center; padding: 2rem;">Nenhuma anota√ß√£o ainda. Selecione um produto e desenhe na imagem.</div>';
        return;
    }
    
    lista.innerHTML = anotacoes.map(a => `
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #667eea;">
            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 0.5rem;">${a.produto_nome}</div>
            <button onclick="removerAnotacao(${a.id})" style="width: 100%; padding: 0.5rem; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                üóëÔ∏è Remover
            </button>
        </div>
    `).join('');
}

// Iniciar desenho
canvas.addEventListener('mousedown', function(e) {
    if (!produtoSelecionado) {
        alert('Selecione um produto primeiro!');
        return;
    }
    
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    
    // Criar box tempor√°rio
    currentBox = document.createElement('div');
    currentBox.className = 'bbox';
    currentBox.style.left = startX + 'px';
    currentBox.style.top = startY + 'px';
    currentBox.style.width = '0px';
    currentBox.style.height = '0px';
    currentBox.style.borderColor = '#f39c12';
    container.appendChild(currentBox);
});

// Desenhar
canvas.addEventListener('mousemove', function(e) {
    if (!isDrawing || !currentBox) return;
    
    const rect = canvas.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    const width = Math.abs(currentX - startX);
    const height = Math.abs(currentY - startY);
    const left = Math.min(startX, currentX);
    const top = Math.min(startY, currentY);
    
    currentBox.style.left = left + 'px';
    currentBox.style.top = top + 'px';
    currentBox.style.width = width + 'px';
    currentBox.style.height = height + 'px';
});

// Finalizar desenho
canvas.addEventListener('mouseup', function(e) {
    if (!isDrawing || !currentBox) return;
    
    isDrawing = false;
    
    const rect = canvas.getBoundingClientRect();
    const boxRect = currentBox.getBoundingClientRect();
    
    const width = parseInt(currentBox.style.width);
    const height = parseInt(currentBox.style.height);
    
    // Validar tamanho m√≠nimo
    if (width < 20 || height < 20) {
        currentBox.remove();
        currentBox = null;
        return;
    }
    
    // Converter para coordenadas normalizadas (0-1)
    const displayWidth = rect.width;
    const displayHeight = rect.height;
    
    const left = parseInt(currentBox.style.left);
    const top = parseInt(currentBox.style.top);
    
    const bbox_x = (left + width / 2) / displayWidth;
    const bbox_y = (top + height / 2) / displayHeight;
    const bbox_width = width / displayWidth;
    const bbox_height = height / displayHeight;
    
    // Salvar anota√ß√£o
    salvarAnotacao(bbox_x, bbox_y, bbox_width, bbox_height);
    
    currentBox.remove();
    currentBox = null;
});

function salvarAnotacao(x, y, width, height) {
    fetch('{% url "salvar_anotacao" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            imagem_id: imagemId,
            produto_id: produtoSelecionado.id,
            bbox_x: x,
            bbox_y: y,
            bbox_width: width,
            bbox_height: height
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Adicionar √† lista local
            anotacoes.push({
                id: data.anotacao_id,
                produto_id: produtoSelecionado.id,
                produto_nome: produtoSelecionado.nome,
                x: x,
                y: y,
                width: width,
                height: height
            });
            
            counter.textContent = data.total;
            renderizarAnotacoes();
        } else {
            alert('Erro ao salvar: ' + data.error);
        }
    });
}

function removerAnotacao(anotacaoId) {
    if (!confirm('Remover esta anota√ß√£o?')) return;
    
    fetch(`/coleta/anotar/remover/${anotacaoId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            anotacoes = anotacoes.filter(a => a.id !== anotacaoId);
            counter.textContent = data.total;
            renderizarAnotacoes();
        }
    });
}

// Renderizar ao carregar
window.addEventListener('load', renderizarAnotacoes);
window.addEventListener('resize', renderizarAnotacoes);
</script>
{% endblock %}
