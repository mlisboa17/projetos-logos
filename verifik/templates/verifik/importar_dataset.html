{% extends 'verifik/base.html' %}

{% block title %}Importar Dataset - VerifiK{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin: 2rem auto; padding: 0 1rem;">
    <div class="card" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 2rem;">
        <div class="card-header" style="border-bottom: 2px solid #667eea; padding-bottom: 1rem; margin-bottom: 2rem;">
            <h2 style="color: #667eea; margin: 0;">üì• Importar Dataset de Treinamento</h2>
            <p style="color: #7f8c8d; margin-top: 0.5rem;">Importe as imagens aprovadas para o dataset de treino do modelo YOLO</p>
        </div>

        <!-- Estat√≠sticas Gerais -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">{{ stats_simples.total }}</div>
                <div style="opacity: 0.9; font-size: 1.1rem; font-weight: 600;">Imagens Simples</div>
                <div style="opacity: 0.8; font-size: 0.9rem; margin-top: 0.5rem;">1 produto por foto</div>
            </div>
            
            <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">{{ stats_anotadas.total_imagens }}</div>
                <div style="opacity: 0.9; font-size: 1.1rem; font-weight: 600;">Imagens Anotadas</div>
                <div style="opacity: 0.8; font-size: 0.9rem; margin-top: 0.5rem;">M√∫ltiplos produtos</div>
            </div>
            
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">{{ stats_anotadas.total_anotacoes }}</div>
                <div style="opacity: 0.9; font-size: 1.1rem; font-weight: 600;">Total de Anota√ß√µes</div>
                <div style="opacity: 0.8; font-size: 0.9rem; margin-top: 0.5rem;">Bounding boxes criados</div>
            </div>
        </div>

        <!-- Se√ß√£o de Imagens Simples -->
        <div class="import-section" style="background: #f8f9fa; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h3 style="color: #2c3e50; margin: 0 0 0.5rem 0;">üì∏ Imagens Simples (1 Produto por Foto)</h3>
                    <p style="color: #7f8c8d; margin: 0;">Fotos enviadas pelos funcion√°rios com um √∫nico produto</p>
                </div>
                <button onclick="importarSimples()" class="btn-import" style="padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    üì• Importar Simples
                </button>
            </div>
            
            {% if stats_simples.por_produto %}
            <div style="background: white; padding: 1.5rem; border-radius: 8px;">
                <h4 style="color: #2c3e50; margin-bottom: 1rem;">Distribui√ß√£o por Produto:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    {% for produto, count in stats_simples.por_produto.items %}
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #667eea;">
                        <span style="font-weight: 600; color: #2c3e50;">{{ produto }}</span>
                        <span style="background: #667eea; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                <p>Nenhuma imagem simples aprovada ainda.</p>
            </div>
            {% endif %}
        </div>

        <!-- Se√ß√£o de Imagens Anotadas -->
        <div class="import-section" style="background: #f0fff4; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h3 style="color: #2c3e50; margin: 0 0 0.5rem 0;">üì¶ Imagens Anotadas (M√∫ltiplos Produtos)</h3>
                    <p style="color: #7f8c8d; margin: 0;">Fotos com bounding boxes marcando cada produto</p>
                </div>
                <button onclick="importarAnotadas()" class="btn-import" style="padding: 1rem 2rem; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    üì• Importar Anotadas
                </button>
            </div>
            
            {% if stats_anotadas.por_produto %}
            <div style="background: white; padding: 1.5rem; border-radius: 8px;">
                <h4 style="color: #2c3e50; margin-bottom: 1rem;">Distribui√ß√£o por Produto:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    {% for produto, count in stats_anotadas.por_produto.items %}
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f0fff4; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <span style="font-weight: 600; color: #2c3e50;">{{ produto }}</span>
                        <span style="background: #27ae60; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 2rem; color: #7f8c8d;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                <p>Nenhuma imagem anotada aprovada ainda.</p>
            </div>
            {% endif %}
        </div>

        <!-- Informa√ß√µes sobre o Dataset -->
        <div style="background: #fff3cd; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f39c12;">
            <h4 style="color: #856404; margin: 0 0 1rem 0;">‚ÑπÔ∏è Informa√ß√µes Importantes</h4>
            <ul style="color: #856404; margin: 0; padding-left: 1.5rem;">
                <li style="margin-bottom: 0.5rem;"><strong>Destino:</strong> As imagens ser√£o copiadas para <code>assets/dataset/train/{nome_produto}/</code></li>
                <li style="margin-bottom: 0.5rem;"><strong>Imagens Simples:</strong> Apenas a foto √© copiada (ideal para transfer learning)</li>
                <li style="margin-bottom: 0.5rem;"><strong>Imagens Anotadas:</strong> Foto + arquivo .txt com coordenadas dos bounding boxes (formato YOLO)</li>
                <li style="margin-bottom: 0.5rem;"><strong>Backup:</strong> As imagens originais s√£o mantidas no sistema</li>
                <li style="margin-bottom: 0.5rem;"><strong>Duplicatas:</strong> Imagens j√° importadas n√£o ser√£o duplicadas (timestamp √∫nico)</li>
            </ul>
        </div>

        <!-- √Årea de Resultado -->
        <div id="resultado" style="margin-top: 2rem; display: none;"></div>
    </div>
</div>

<script>
function importarSimples() {
    if (!confirm('Deseja importar todas as imagens simples aprovadas para o dataset de treino?')) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ Importando...';
    
    const formData = new FormData();
    formData.append('tipo', 'simples');
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "executar_importacao" %}', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        mostrarResultado(data);
        btn.disabled = false;
        btn.textContent = 'üì• Importar Simples';
    })
    .catch(err => {
        alert('Erro: ' + err);
        btn.disabled = false;
        btn.textContent = 'üì• Importar Simples';
    });
}

function importarAnotadas() {
    if (!confirm('Deseja importar todas as imagens anotadas aprovadas para o dataset de treino?')) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ Importando...';
    
    const formData = new FormData();
    formData.append('tipo', 'anotadas');
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "executar_importacao" %}', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        mostrarResultado(data);
        btn.disabled = false;
        btn.textContent = 'üì• Importar Anotadas';
    })
    .catch(err => {
        alert('Erro: ' + err);
        btn.disabled = false;
        btn.textContent = 'üì• Importar Anotadas';
    });
}

function mostrarResultado(data) {
    const resultado = document.getElementById('resultado');
    resultado.style.display = 'block';
    
    if (data.success) {
        resultado.innerHTML = `
            <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 1.5rem; border-radius: 8px;">
                <h4 style="margin: 0 0 1rem 0;">‚úÖ ${data.mensagem}</h4>
                <p style="margin: 0;"><strong>Total de imagens importadas:</strong> ${data.importadas}</p>
                ${data.erros.length > 0 ? `
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; font-weight: 600;">‚ö†Ô∏è ${data.erros.length} erro(s) encontrado(s)</summary>
                        <ul style="margin-top: 0.5rem;">
                            ${data.erros.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </details>
                ` : ''}
            </div>
        `;
    } else {
        resultado.innerHTML = `
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 1.5rem; border-radius: 8px;">
                <h4 style="margin: 0 0 1rem 0;">‚ùå Erro na Importa√ß√£o</h4>
                <p style="margin: 0;">${data.error}</p>
            </div>
        `;
    }
    
    // Scroll para o resultado
    resultado.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
</script>
{% endblock %}
