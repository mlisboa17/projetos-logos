{% extends 'verifik/base.html' %}
{% load static %}

{% block title %}Treinamento - Interface de Anotação{% endblock %}

{% block extra_css %}
<style>
    .dropzone {
        border: 3px dashed #0087F7;
        border-radius: 10px;
        padding: 50px;
        text-align: center;
        cursor: pointer;
        background: #f8f9fa;
        transition: all 0.3s;
    }
    .dropzone:hover {
        background: #e9ecef;
        border-color: #0056b3;
    }
    .dropzone.dragover {
        background: #cfe2ff;
        border-color: #0056b3;
    }
    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .preview-item {
        position: relative;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s;
    }
    .preview-item:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .preview-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    .preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-weight: bold;
    }
    .preview-item .annotate-btn {
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        background: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 15px;
        cursor: pointer;
    }
    .preview-item.annotated {
        border-color: #28a745;
        border-width: 3px;
    }
    .preview-item.annotated::after {
        content: '✓';
        position: absolute;
        top: 5px;
        left: 5px;
        background: #28a745;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 20px;
    }
    #annotationCanvas {
        border: 2px solid #333;
        cursor: crosshair;
        max-width: 100%;
    }
    .annotation-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
    }
    .annotation-content {
        background-color: white;
        margin: 2% auto;
        padding: 20px;
        width: 90%;
        max-width: 1200px;
        border-radius: 10px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .bbox-list {
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
    }
    .bbox-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 5px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    .stats-panel {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    .stats-item {
        display: inline-block;
        margin-right: 30px;
        font-size: 16px;
    }
    .stats-item strong {
        color: #0087F7;
        font-size: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-brain"></i> Interface de Treinamento - Anotação de Produtos</h2>
    <p class="text-muted">Faça upload de imagens, anote os produtos e treine o modelo incrementalmente</p>
    
    <hr>
    
    <!-- Upload Zone -->
    <div class="card mb-4">
        <div class="card-body">
            <h5><i class="fas fa-upload"></i> Upload de Imagens</h5>
            <div id="dropzone" class="dropzone">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <p class="mb-2"><strong>Arraste imagens aqui</strong> ou clique para selecionar</p>
                <p class="text-muted">Suporta: JPG, PNG, JPEG</p>
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
            </div>
        </div>
    </div>
    
    <!-- Stats Panel -->
    <div class="stats-panel" id="statsPanel" style="display: none;">
        <div class="stats-item">
            <i class="fas fa-images"></i> Imagens: <strong id="totalImages">0</strong>
        </div>
        <div class="stats-item">
            <i class="fas fa-check-circle text-success"></i> Anotadas: <strong id="annotatedImages">0</strong>
        </div>
        <div class="stats-item">
            <i class="fas fa-box"></i> Total de Produtos: <strong id="totalProducts">0</strong>
        </div>
    </div>
    
    <!-- Preview Grid -->
    <div id="previewGrid" class="preview-grid"></div>
    
    <!-- Action Buttons -->
    <div class="text-center mt-4" id="actionButtons" style="display: none;">
        <button class="btn btn-primary btn-lg" id="trainBtn">
            <i class="fas fa-rocket"></i> Iniciar Treinamento Incremental
        </button>
        <button class="btn btn-secondary btn-lg" id="clearBtn">
            <i class="fas fa-trash"></i> Limpar Tudo
        </button>
    </div>
</div>

<!-- Annotation Modal -->
<div id="annotationModal" class="annotation-modal">
    <div class="annotation-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-draw-polygon"></i> Anotar Produtos</h4>
            <button class="btn btn-danger" id="closeModal">&times; Fechar</button>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div style="overflow: auto; max-height: 600px;">
                    <canvas id="annotationCanvas"></canvas>
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-danger" id="undoBtn">
                        <i class="fas fa-undo"></i> Desfazer Última Bbox
                    </button>
                    <button class="btn btn-sm btn-warning" id="clearBboxBtn">
                        <i class="fas fa-eraser"></i> Limpar Todas Bboxes
                    </button>
                </div>
            </div>
            
            <div class="col-md-4">
                <h5>Instruções:</h5>
                <ol>
                    <li>Clique e arraste para desenhar retângulo</li>
                    <li>Selecione o produto na lista</li>
                    <li>Repita para cada produto na imagem</li>
                    <li>Clique em "Salvar Anotações"</li>
                </ol>
                
                <hr>
                
                <h5>Produtos Marcados:</h5>
                <div id="bboxList" class="bbox-list">
                    <p class="text-muted">Nenhum produto marcado ainda</p>
                </div>
                
                <hr>
                
                <button class="btn btn-success btn-block" id="saveAnnotations">
                    <i class="fas fa-save"></i> Salvar Anotações
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Product Selection Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Selecione o Produto</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-3" id="productSearch" placeholder="Buscar produto...">
                <div id="productList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let uploadedImages = [];
let currentImageIndex = -1;
let bboxes = [];
let drawing = false;
let startX, startY;
let canvas, ctx;
let currentRect = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', handleDragOver);
    dropzone.addEventListener('dragleave', handleDragLeave);
    dropzone.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);
    
    document.getElementById('trainBtn').addEventListener('click', startTraining);
    document.getElementById('clearBtn').addEventListener('click', clearAll);
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('saveAnnotations').addEventListener('click', saveAnnotations);
    document.getElementById('undoBtn').addEventListener('click', undoLastBbox);
    document.getElementById('clearBboxBtn').addEventListener('click', clearAllBboxes);
    
    loadProducts();
});

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    const files = e.dataTransfer.files;
    processFiles(files);
}

function handleFileSelect(e) {
    const files = e.target.files;
    processFiles(files);
}

function processFiles(files) {
    for (let file of files) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImages.push({
                    file: file,
                    dataUrl: e.target.result,
                    annotations: []
                });
                updatePreview();
                updateStats();
            };
            reader.readAsDataURL(file);
        }
    }
}

function updatePreview() {
    const grid = document.getElementById('previewGrid');
    grid.innerHTML = '';
    
    uploadedImages.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        if (img.annotations.length > 0) {
            item.classList.add('annotated');
        }
        
        item.innerHTML = `
            <img src="${img.dataUrl}" alt="Imagem ${index + 1}">
            <button class="remove-btn" onclick="removeImage(${index})">&times;</button>
            <button class="annotate-btn" onclick="openAnnotation(${index})">
                ${img.annotations.length > 0 ? 'Editar (' + img.annotations.length + ')' : 'Anotar'}
            </button>
        `;
        
        grid.appendChild(item);
    });
    
    document.getElementById('statsPanel').style.display = uploadedImages.length > 0 ? 'block' : 'none';
    document.getElementById('actionButtons').style.display = uploadedImages.length > 0 ? 'block' : 'none';
}

function updateStats() {
    document.getElementById('totalImages').textContent = uploadedImages.length;
    const annotated = uploadedImages.filter(img => img.annotations.length > 0).length;
    document.getElementById('annotatedImages').textContent = annotated;
    const totalProducts = uploadedImages.reduce((sum, img) => sum + img.annotations.length, 0);
    document.getElementById('totalProducts').textContent = totalProducts;
}

function removeImage(index) {
    if (confirm('Remover esta imagem?')) {
        uploadedImages.splice(index, 1);
        updatePreview();
        updateStats();
    }
}

function openAnnotation(index) {
    currentImageIndex = index;
    const img = uploadedImages[index];
    bboxes = JSON.parse(JSON.stringify(img.annotations)); // Deep copy
    
    const modal = document.getElementById('annotationModal');
    modal.style.display = 'block';
    
    canvas = document.getElementById('annotationCanvas');
    ctx = canvas.getContext('2d');
    
    const image = new Image();
    image.onload = function() {
        canvas.width = image.width;
        canvas.height = image.height;
        drawImage(image);
        
        canvas.onmousedown = startDrawing;
        canvas.onmousemove = draw;
        canvas.onmouseup = endDrawing;
    };
    image.src = img.dataUrl;
    
    updateBboxList();
}

function drawImage(image) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(image, 0, 0);
    
    // Draw existing bboxes
    bboxes.forEach((bbox, index) => {
        ctx.strokeStyle = '#00FF00';
        ctx.lineWidth = 3;
        ctx.strokeRect(bbox.x, bbox.y, bbox.width, bbox.height);
        
        ctx.fillStyle = '#00FF00';
        ctx.font = '16px Arial';
        ctx.fillText(`${index + 1}. ${bbox.product}`, bbox.x + 5, bbox.y - 5);
    });
}

function startDrawing(e) {
    const rect = canvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    drawing = true;
}

function draw(e) {
    if (!drawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    const image = new Image();
    image.src = uploadedImages[currentImageIndex].dataUrl;
    image.onload = function() {
        drawImage(image);
        
        ctx.strokeStyle = '#FF0000';
        ctx.lineWidth = 2;
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    };
}

function endDrawing(e) {
    if (!drawing) return;
    drawing = false;
    
    const rect = canvas.getBoundingClientRect();
    const endX = e.clientX - rect.left;
    const endY = e.clientY - rect.top;
    
    const width = endX - startX;
    const height = endY - startY;
    
    if (Math.abs(width) > 20 && Math.abs(height) > 20) {
        currentRect = {
            x: Math.min(startX, endX),
            y: Math.min(startY, endY),
            width: Math.abs(width),
            height: Math.abs(height)
        };
        
        $('#productModal').modal('show');
    }
}

function selectProduct(productId, productName) {
    if (currentRect) {
        bboxes.push({
            ...currentRect,
            product_id: productId,
            product: productName
        });
        
        const image = new Image();
        image.src = uploadedImages[currentImageIndex].dataUrl;
        image.onload = function() {
            drawImage(image);
        };
        
        updateBboxList();
        currentRect = null;
        $('#productModal').modal('hide');
    }
}

function updateBboxList() {
    const list = document.getElementById('bboxList');
    
    if (bboxes.length === 0) {
        list.innerHTML = '<p class="text-muted">Nenhum produto marcado ainda</p>';
        return;
    }
    
    list.innerHTML = bboxes.map((bbox, index) => `
        <div class="bbox-item">
            <span>${index + 1}. ${bbox.product}</span>
            <button class="btn btn-sm btn-danger" onclick="removeBbox(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

function removeBbox(index) {
    bboxes.splice(index, 1);
    const image = new Image();
    image.src = uploadedImages[currentImageIndex].dataUrl;
    image.onload = function() {
        drawImage(image);
    };
    updateBboxList();
}

function undoLastBbox() {
    if (bboxes.length > 0) {
        removeBbox(bboxes.length - 1);
    }
}

function clearAllBboxes() {
    if (confirm('Limpar todas as anotações desta imagem?')) {
        bboxes = [];
        const image = new Image();
        image.src = uploadedImages[currentImageIndex].dataUrl;
        image.onload = function() {
            drawImage(image);
        };
        updateBboxList();
    }
}

function saveAnnotations() {
    uploadedImages[currentImageIndex].annotations = JSON.parse(JSON.stringify(bboxes));
    closeModal();
    updatePreview();
    updateStats();
    alert('Anotações salvas!');
}

function closeModal() {
    document.getElementById('annotationModal').style.display = 'none';
}

function clearAll() {
    if (confirm('Limpar todas as imagens e anotações?')) {
        uploadedImages = [];
        updatePreview();
        updateStats();
    }
}

function loadProducts() {
    fetch('/verifik/api/produtos/')
        .then(response => response.json())
        .then(products => {
            renderProductList(products);
            
            document.getElementById('productSearch').addEventListener('input', function(e) {
                const search = e.target.value.toLowerCase();
                const filtered = products.filter(p => 
                    p.marca.toLowerCase().includes(search) || 
                    p.descricao_produto.toLowerCase().includes(search)
                );
                renderProductList(filtered);
            });
        });
}

function renderProductList(products) {
    const list = document.getElementById('productList');
    list.innerHTML = products.map(p => `
        <div class="list-group-item list-group-item-action" onclick="selectProduct(${p.id}, '${p.marca} - ${p.descricao_produto}')" style="cursor: pointer;">
            <strong>${p.marca}</strong> - ${p.descricao_produto}
        </div>
    `).join('');
}

async function startTraining() {
    const annotated = uploadedImages.filter(img => img.annotations.length > 0);
    
    if (annotated.length === 0) {
        alert('Você precisa anotar pelo menos uma imagem antes de treinar!');
        return;
    }
    
    if (!confirm(`Iniciar treinamento com ${annotated.length} imagem(ns) anotada(s)?`)) {
        return;
    }
    
    const formData = new FormData();
    
    annotated.forEach((img, index) => {
        formData.append('images', img.file);
        formData.append(`annotations_${index}`, JSON.stringify(img.annotations));
    });
    
    const btn = document.getElementById('trainBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Treinando...';
    
    try {
        const response = await fetch('/verifik/treinar-incremental/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Treinamento iniciado com sucesso!\n\nImagens processadas: ${result.images_processed}\nProdutos detectados: ${result.total_products}`);
            clearAll();
        } else {
            alert('Erro: ' + result.error);
        }
    } catch (error) {
        alert('Erro ao enviar dados: ' + error);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-rocket"></i> Iniciar Treinamento Incremental';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
