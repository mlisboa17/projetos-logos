{% extends 'verifik/base.html' %}

{% block title %}{{ produto.descricao_produto }} - VerifiK{% endblock %}

{% block content %}
<div class="card">
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
        <div>
            {% if produto.imagem_referencia %}
            <img src="{{ produto.imagem_referencia.url }}" alt="{{ produto.descricao_produto }}"
                 style="width: 100%; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            {% else %}
            <div style="width: 100%; aspect-ratio: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 6rem;">
                üì¶
            </div>
            {% endif %}
            
            <div style="margin-top: 1.5rem;">
                <div class="stat-card" style="margin-bottom: 1rem;">
                    <h3>Detec√ß√µes IA</h3>
                    <div class="number">{{ total_deteccoes }}</div>
                </div>
                
                <div class="stat-card" style="border-left-color: #27ae60;">
                    <h3>Vendas Totais</h3>
                    <div class="number" style="color: #27ae60;">{{ total_vendas }}</div>
                </div>
                
                <!-- PAINEL DE TREINAMENTO -->
                <div class="stat-card" style="border-left-color: #667eea; background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);">
                    <h3 style="color: #667eea;">ü§ñ Treinamento IA</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                        <div>
                            <div style="font-size: 0.85rem; color: #7f8c8d;">Novas</div>
                            <div class="number" style="font-size: 1.5rem; color: #e74c3c;">{{ imagens_nao_treinadas }}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #7f8c8d;">Treinadas</div>
                            <div class="number" style="font-size: 1.5rem; color: #27ae60;">{{ imagens_treinadas }}</div>
                        </div>
                    </div>
                    
                    {% if imagens_nao_treinadas > 0 %}
                    <button onclick="treinarProduto()" 
                            style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.95rem; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);"
                            onmouseover="this.style.transform='scale(1.05)'"
                            onmouseout="this.style.transform='scale(1)'">
                        üöÄ Treinar Este Produto
                    </button>
                    {% else %}
                    <div style="margin-top: 1rem; padding: 0.75rem; background: #e8f5e9; border-radius: 8px; text-align: center; color: #2e7d32; font-size: 0.9rem;">
                        ‚úÖ Todas as imagens foram treinadas
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div>
            <h1 style="margin-bottom: 1rem;">{{ produto.descricao_produto }}</h1>
            
            <div style="margin-bottom: 1.5rem;">
                {% if produto.marca %}
                <p style="font-size: 1.1rem; color: #7f8c8d; margin-bottom: 0.5rem;">
                    <strong>Marca:</strong> {{ produto.marca }}
                </p>
                {% endif %}
                
                {% if produto.tipo %}
                <p style="font-size: 1.1rem; color: #7f8c8d; margin-bottom: 0.5rem;">
                    <strong>Tipo:</strong> {{ produto.tipo }}
                </p>
                {% endif %}
                
                <p style="font-size: 2rem; color: #27ae60; font-weight: bold; margin: 1rem 0;">
                    R$ {{ produto.preco }}
                </p>
                
                <p style="color: #95a5a6;">
                    <strong>C√≥digo de Barras:</strong> {{ produto.codigo_barras }}
                </p>
                
                <p style="color: #95a5a6;">
                    <strong>Status:</strong> 
                    {% if produto.ativo %}
                        <span class="badge badge-success">Ativo</span>
                    {% else %}
                        <span class="badge badge-danger">Inativo</span>
                    {% endif %}
                </p>
            </div>
            
            <div style="margin-top: 2rem;">
                <a href="/admin/verifik/produtomae/{{ produto.pk }}/change/" class="btn" style="margin-right: 1rem;">
                    ‚úèÔ∏è Editar Produto
                </a>
                <a href="{% url 'verifik_produtos_lista' %}" class="btn" style="background: #95a5a6;">
                    ‚Üê Voltar
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>üñºÔ∏è Imagens para Treinamento da IA ({{ imagens_treino.count }} imagens)</h2>
    
    {% if is_admin %}
    <div style="margin: 1.5rem 0; padding: 1.5rem; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 10px; border: 2px dashed #667eea;">
        <h3 style="margin-bottom: 1rem; color: #667eea;">‚ûï Adicionar e Anotar Imagens</h3>
        
        <!-- UPLOAD DE IMAGENS -->
        <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Selecionar Imagens:</label>
            <input type="file" accept="image/*" multiple id="imagensInput"
                   style="padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px; width: 100%;">
            <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">
                <strong>Ctrl/Cmd + clique</strong> para m√∫ltiplas ou arraste arquivos aqui<br>
                <span id="fileCount" style="color: #27ae60; font-weight: bold;"></span>
            </small>
        </div>
        
        <!-- PREVIEW E ANOTA√á√ÉO -->
        <div id="imagePreviewArea" style="display: none;">
            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0;">üì∏ Imagem <span id="currentImageNumber">1</span> de <span id="totalImages">0</span></h4>
                
                <!-- Canvas para desenhar bboxes -->
                <div style="position: relative; display: inline-block;">
                    <canvas id="annotationCanvas" style="border: 2px solid #667eea; border-radius: 8px; cursor: crosshair; max-width: 100%;"></canvas>
                </div>
                
                <!-- Instru√ß√µes -->
                <div style="background: #e3f2fd; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                    <p style="margin: 0; font-size: 0.9rem; color: #1976d2;">
                        <strong>üìå Como anotar:</strong><br>
                        1. Clique e arraste para desenhar um ret√¢ngulo ao redor do produto<br>
                        2. Selecione qual produto est√° na regi√£o marcada<br>
                        3. Repita para cada produto na imagem<br>
                        4. Clique em "Pr√≥xima Imagem" quando terminar
                    </p>
                </div>
                
                <!-- Produtos detectados na imagem atual -->
                <div id="currentAnnotations" style="margin-top: 1rem;">
                    <h5 style="margin: 0 0 0.5rem 0;">Produtos marcados nesta imagem:</h5>
                    <div id="annotationsList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <em style="color: #95a5a6;">Nenhum produto marcado ainda</em>
                    </div>
                </div>
                
                <!-- Bot√µes de navega√ß√£o -->
                <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: space-between;">
                    <button onclick="undoLastAnnotation()" class="btn" style="background: #f39c12;">
                        ‚Ü∂ Desfazer √öltima
                    </button>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="previousImage()" id="btnPrevious" class="btn" style="background: #95a5a6;">
                            ‚Üê Anterior
                        </button>
                        <button onclick="nextImage()" id="btnNext" class="btn" style="background: #3498db;">
                            Pr√≥xima ‚Üí
                        </button>
                        <button onclick="saveAllAnnotations()" id="btnSave" class="btn" style="background: #27ae60; display: none;">
                            üíæ Salvar Todas
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bot√£o para cancelar -->
        <div id="cancelArea" style="display: none; margin-top: 1rem;">
            <button onclick="cancelAnnotation()" class="btn" style="background: #e74c3c; width: 100%;">
                ‚úï Cancelar Anota√ß√£o
            </button>
        </div>
        
        <script>
            // Estado da anota√ß√£o
            let uploadedImages = [];
            let currentImageIndex = 0;
            let canvas, ctx;
            let drawing = false;
            let startX, startY;
            let currentRect = null;
            let allProdutos = [];
            
            const input = document.getElementById('imagensInput');
            const countSpan = document.getElementById('fileCount');
            
            // Buscar lista de produtos ao carregar
            fetch('/verifik/api/produtos/')
                .then(r => r.json())
                .then(data => {
                    allProdutos = data;
                });
            
            input.addEventListener('change', function(e) {
                const count = e.target.files.length;
                if (count > 0) {
                    countSpan.textContent = `‚úì ${count} imagem${count > 1 ? 'ns' : ''} selecionada${count > 1 ? 's' : ''}`;
                    processFiles(e.target.files);
                } else {
                    countSpan.textContent = '';
                }
            });
            
            function processFiles(files) {
                uploadedImages = [];
                
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages.push({
                            file: file,
                            dataURL: e.target.result,
                            annotations: []
                        });
                        
                        if (uploadedImages.length === files.length) {
                            startAnnotation();
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            function startAnnotation() {
                document.getElementById('imagePreviewArea').style.display = 'block';
                document.getElementById('cancelArea').style.display = 'block';
                document.getElementById('totalImages').textContent = uploadedImages.length;
                
                canvas = document.getElementById('annotationCanvas');
                ctx = canvas.getContext('2d');
                
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', endDrawing);
                
                loadImage(0);
            }
            
            function loadImage(index) {
                currentImageIndex = index;
                const imgData = uploadedImages[index];
                
                const img = new Image();
                img.onload = function() {
                    const maxWidth = 800;
                    const scale = Math.min(1, maxWidth / img.width);
                    
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Redesenhar anota√ß√µes existentes
                    imgData.annotations.forEach(ann => {
                        drawBox(ann.x, ann.y, ann.width, ann.height, '#27ae60');
                    });
                };
                img.src = imgData.dataURL;
                
                document.getElementById('currentImageNumber').textContent = index + 1;
                updateAnnotationsList();
                updateNavigationButtons();
            }
            
            function startDrawing(e) {
                const rect = canvas.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                drawing = true;
            }
            
            function draw(e) {
                if (!drawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                // Redesenhar imagem
                loadImage(currentImageIndex);
                
                // Desenhar ret√¢ngulo atual
                const width = currentX - startX;
                const height = currentY - startY;
                drawBox(startX, startY, width, height, '#667eea');
            }
            
            function drawBox(x, y, width, height, color) {
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, width, height);
            }
            
            function endDrawing(e) {
                if (!drawing) return;
                drawing = false;
                
                const rect = canvas.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;
                
                const width = endX - startX;
                const height = endY - startY;
                
                if (Math.abs(width) > 20 && Math.abs(height) > 20) {
                    selectProduct(startX, startY, width, height);
                }
            }
            
            function selectProduct(x, y, width, height) {
                // Criar modal para sele√ß√£o de produto
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                
                const content = document.createElement('div');
                content.style.cssText = 'background: white; padding: 2rem; border-radius: 15px; max-width: 500px; max-height: 80vh; overflow-y: auto;';
                
                content.innerHTML = `
                    <h3 style="margin: 0 0 1rem 0;">Selecione o Produto</h3>
                    <input type="text" id="produtoSearch" placeholder="Buscar produto..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 1rem;">
                    <div id="produtosList" style="max-height: 400px; overflow-y: auto;"></div>
                    <button onclick="this.closest('[style*=fixed]').remove()" 
                            style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: #95a5a6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Cancelar
                    </button>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                renderProdutosList(allProdutos);
                
                document.getElementById('produtoSearch').addEventListener('input', function(e) {
                    const search = e.target.value.toLowerCase();
                    const filtered = allProdutos.filter(p => 
                        p.marca.toLowerCase().includes(search) || 
                        p.descricao_produto.toLowerCase().includes(search)
                    );
                    renderProdutosList(filtered);
                });
                
                function renderProdutosList(produtos) {
                    const list = document.getElementById('produtosList');
                    list.innerHTML = produtos.map(p => `
                        <div onclick="addAnnotation(${p.id}, '${p.marca} ${p.descricao_produto}', ${x}, ${y}, ${width}, ${height}); this.closest('[style*=fixed]').remove();"
                             style="padding: 1rem; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: background 0.2s;"
                             onmouseover="this.style.background='#f8f9fa'"
                             onmouseout="this.style.background='white'">
                            <strong>${p.marca}</strong><br>
                            <span style="color: #7f8c8d; font-size: 0.9rem;">${p.descricao_produto}</span>
                        </div>
                    `).join('');
                }
            }
            
            function addAnnotation(productId, productName, x, y, width, height) {
                uploadedImages[currentImageIndex].annotations.push({
                    product_id: productId,
                    product_name: productName,
                    x: x,
                    y: y,
                    width: width,
                    height: height
                });
                
                loadImage(currentImageIndex);
                updateAnnotationsList();
            }
            
            function updateAnnotationsList() {
                const list = document.getElementById('annotationsList');
                const annotations = uploadedImages[currentImageIndex].annotations;
                
                if (annotations.length === 0) {
                    list.innerHTML = '<em style="color: #95a5a6;">Nenhum produto marcado ainda</em>';
                } else {
                    list.innerHTML = annotations.map((ann, idx) => `
                        <span style="background: #27ae60; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">
                            ${idx + 1}. ${ann.product_name}
                        </span>
                    `).join('');
                }
            }
            
            function undoLastAnnotation() {
                uploadedImages[currentImageIndex].annotations.pop();
                loadImage(currentImageIndex);
            }
            
            function previousImage() {
                if (currentImageIndex > 0) {
                    loadImage(currentImageIndex - 1);
                }
            }
            
            function nextImage() {
                if (currentImageIndex < uploadedImages.length - 1) {
                    loadImage(currentImageIndex + 1);
                }
            }
            
            function updateNavigationButtons() {
                document.getElementById('btnPrevious').disabled = currentImageIndex === 0;
                document.getElementById('btnNext').style.display = currentImageIndex === uploadedImages.length - 1 ? 'none' : 'inline-block';
                document.getElementById('btnSave').style.display = currentImageIndex === uploadedImages.length - 1 ? 'inline-block' : 'none';
            }
            
            function saveAllAnnotations() {
                // Verificar se todas as imagens t√™m anota√ß√µes
                const semAnotacao = uploadedImages.filter(img => img.annotations.length === 0);
                if (semAnotacao.length > 0) {
                    if (!confirm(`${semAnotacao.length} imagem(ns) n√£o t√™m produtos marcados. Deseja continuar mesmo assim?`)) {
                        return;
                    }
                }
                
                const formData = new FormData();
                
                uploadedImages.forEach((img, index) => {
                    formData.append('images', img.file);
                    formData.append(`annotations_${index}`, JSON.stringify(img.annotations));
                });
                
                // Mostrar loading
                document.getElementById('btnSave').textContent = '‚è≥ Salvando...';
                document.getElementById('btnSave').disabled = true;
                
                fetch('/verifik/treinar-incremental/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ Sucesso! ${data.total_products} produtos salvos. Treinamento iniciado em background.`);
                        window.location.reload();
                    } else {
                        alert('Erro: ' + data.error);
                        document.getElementById('btnSave').textContent = 'üíæ Salvar Todas';
                        document.getElementById('btnSave').disabled = false;
                    }
                })
                .catch(error => {
                    alert('Erro: ' + error);
                    document.getElementById('btnSave').textContent = 'üíæ Salvar Todas';
                    document.getElementById('btnSave').disabled = false;
                });
            }
            
            function cancelAnnotation() {
                if (confirm('Deseja cancelar? Todas as anota√ß√µes ser√£o perdidas.')) {
                    uploadedImages = [];
                    document.getElementById('imagePreviewArea').style.display = 'none';
                    document.getElementById('cancelArea').style.display = 'none';
                    document.getElementById('imagensInput').value = '';
                    countSpan.textContent = '';
                }
            }
        </script>
    </div>
    {% endif %}
    
    {% if imagens_treino %}
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
        {% for imagem in imagens_treino %}
        <div style="border: 1px solid #ecf0f1; border-radius: 10px; overflow: hidden; position: relative;">
            <img src="{{ imagem.imagem.url }}" alt="{{ imagem.descricao|default:'Imagem de treino' }}"
                 style="width: 100%; height: 200px; object-fit: cover;">
            
            {% if is_admin %}
            <form method="POST" action="{% url 'verifik_remover_imagem' imagem.pk %}" style="position: absolute; top: 0.5rem; right: 0.5rem;"
                  onsubmit="return confirm('Tem certeza que deseja remover esta imagem?');">
                {% csrf_token %}
                <button type="submit" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    ‚úï
                </button>
            </form>
            {% endif %}
            
            {% if imagem.descricao %}
            <div style="padding: 0.75rem; background: #f8f9fa;">
                <p style="font-size: 0.85rem; color: #7f8c8d; margin: 0;">{{ imagem.descricao }}</p>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
        <p style="margin-bottom: 0.5rem;"><strong>üí° Dica:</strong> Para melhor treinamento da IA:</p>
        <ul style="margin-left: 1.5rem; color: #7f8c8d;">
            <li>Adicione 10-20 imagens por produto</li>
            <li>Use diferentes √¢ngulos (frente, verso, laterais)</li>
            <li>Varie ilumina√ß√£o e dist√¢ncias</li>
            <li>Garanta que o r√≥tulo esteja vis√≠vel</li>
        </ul>
    </div>
    {% else %}
    <div style="padding: 2rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; margin-top: 1.5rem;">
        <p style="margin-bottom: 0.5rem;"><strong>‚ö†Ô∏è Nenhuma imagem de treinamento!</strong></p>
        <p style="color: #856404;">Este produto n√£o possui imagens para treinar a IA. {% if is_admin %}Use o formul√°rio acima para adicionar imagens.{% else %}Entre em contato com um administrador para adicionar imagens.{% endif %}</p>
    </div>
    {% endif %}
    
    <div style="margin-top: 1.5rem;">
        <a href="{% url 'verifik_adicionar_imagem' produto.pk %}" class="btn" style="background: #27ae60;">
            ‚ûï Adicionar Imagens
        </a>
    </div>
</div>

<!-- PAINEL DE STATUS DE TREINAMENTO -->
<div id="statusTreinamento" style="display: none; position: fixed; bottom: 20px; right: 20px; background: white; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); padding: 1.5rem 2rem; max-width: 400px; z-index: 1000; border: 2px solid #667eea;">
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <div style="width: 40px; height: 40px; border: 3px solid #667eea; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div>
            <h3 style="margin: 0; color: #667eea;">Treinamento em Andamento</h3>
            <p style="margin: 0.25rem 0 0 0; color: #7f8c8d; font-size: 0.9rem;" id="statusMessage">Iniciando...</p>
        </div>
    </div>
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
        <p style="margin: 0; font-size: 0.85rem; color: #7f8c8d;">
            <strong>üì¶ Produto:</strong> {{ produto.descricao_produto }}<br>
            <strong>üñºÔ∏è Imagens novas:</strong> <span id="countNovas">{{ imagens_nao_treinadas }}</span><br>
            <strong>üé® Com augmentation:</strong> <span id="countTotal">0</span> imagens
        </p>
    </div>
    <script>
        const countNovas = {{ imagens_nao_treinadas|default:0 }};
        document.getElementById('countTotal').textContent = (countNovas * 8);
    </script>
    <button onclick="fecharStatus()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #95a5a6;">‚úï</button>
</div>

<div id="sucessoTreinamento" style="display: none; position: fixed; bottom: 20px; right: 20px; background: #27ae60; color: white; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); padding: 1.5rem 2rem; max-width: 400px; z-index: 1000;">
    <h3 style="margin: 0 0 0.5rem 0;">‚úÖ Treinamento Iniciado!</h3>
    <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;" id="sucessoMessage"></p>
</div>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
}

.stat-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    color: #7f8c8d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-card .number {
    font-size: 2rem;
    font-weight: bold;
    color: #3498db;
}
</style>

<script>
function treinarProduto() {
    const produtoId = {{ produto.pk }};
    const imagensNovas = {{ imagens_nao_treinadas }};
    
    if (!confirm(`Deseja treinar este produto com ${imagensNovas} imagens novas?\n\nSer√£o geradas ${imagensNovas * 8} imagens no total com data augmentation.\n\nO treinamento continuar√° do checkpoint anterior.`)) {
        return;
    }
    
    // Mostrar painel de status
    document.getElementById('statusTreinamento').style.display = 'block';
    document.getElementById('statusMessage').textContent = `Preparando ${imagensNovas} imagens...`;
    
    // Fazer requisi√ß√£o
    fetch('/verifik/treinar-produto/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            produto_id: produtoId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('statusTreinamento').style.display = 'none';
            
            const sucessoDiv = document.getElementById('sucessoTreinamento');
            document.getElementById('sucessoMessage').textContent = data.message;
            sucessoDiv.style.display = 'block';
            
            // Recarregar p√°gina ap√≥s 3 segundos
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            alert('Erro: ' + data.error);
            document.getElementById('statusTreinamento').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao iniciar treinamento: ' + error);
        document.getElementById('statusTreinamento').style.display = 'none';
    });
}

function fecharStatus() {
    document.getElementById('statusTreinamento').style.display = 'none';
}
</script>
{% endblock %}
