{% load fuel_filters %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{% csrf_token %}">
    <title>Dashboard Fuel Prices | LOGOS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #2d3748;
            font-size: 36px;
            font-weight: 700;
        }

        .stat-icon {
            float: right;
            font-size: 40px;
            opacity: 0.2;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .table-header h2 {
            color: #2d3748;
            font-size: 24px;
        }

        .update-time {
            color: #718096;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        th:first-child {
            border-radius: 8px 0 0 0;
            padding-left: 20px;
        }

        th:last-child {
            border-radius: 0 8px 0 0;
            padding-right: 20px;
        }

        tbody tr {
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        td {
            padding: 15px 12px;
            color: #2d3748;
            font-size: 14px;
        }

        td:first-child {
            font-weight: 600;
            color: #4a5568;
            padding-left: 20px;
        }

        .preco {
            font-size: 16px;
            font-weight: 700;
            padding: 8px;
            border-radius: 6px;
            display: inline-block;
            min-width: 100px;
        }

        /* Sistema de cores baseado em M√âDIA */
        .preco-min {
            background: #22c55e;
            color: white;
        }

        .preco-baixo {
            background: #86efac;
            color: #166534;
        }

        .preco-medio-baixo {
            background: #fef08a;
            color: #713f12;
        }

        .preco-medio {
            background: #e5e7eb;
            color: #374151;
        }

        .preco-medio-alto {
            background: #fed7aa;
            color: #9a3412;
        }

        .preco-alto {
            background: #fca5a5;
            color: #991b1b;
        }

        .preco-max {
            background: #ef4444;
            color: white;
        }

        .prazo {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        .sem-preco {
            color: #cbd5e0;
            font-style: italic;
        }

        .variacao {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .variacao-baixa {
            background: #c6f6d5;
            color: #22543d;
        }

        .variacao-media {
            background: #feebc8;
            color: #7c2d12;
        }

        .variacao-alta {
            background: #fed7d7;
            color: #742a2a;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #4a5568;
        }

        .empty-state p {
            font-size: 16px;
        }

        .btn-refresh {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-scraper {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-left: 10px;
        }

        .btn-scraper:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        /* Modal Scraper */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-header h2 {
            color: #2d3748;
            font-size: 24px;
            margin: 0;
        }

        .close {
            color: #718096;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #2d3748;
        }

        .posto-checkbox {
            display: block;
            padding: 12px;
            margin: 8px 0;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .posto-checkbox:hover {
            background: #edf2f7;
        }

        .posto-checkbox input {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .posto-checkbox label {
            cursor: pointer;
            font-size: 14px;
            color: #2d3748;
        }

        .btn-executar {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .btn-executar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .btn-executar:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .select-all {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .posto-header {
            text-align: center;
            font-weight: 700;
        }

        .posto-codigo {
            display: block;
            font-size: 11px;
            color: rgba(255,255,255,0.8);
            margin-top: 2px;
        }

        .posto-data {
            display: block;
            font-size: 10px;
            color: rgba(255,255,255,0.7);
            margin-top: 3px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .stat-value {
                font-size: 28px;
            }

            .table-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚õΩ Dashboard Fuel Prices</h1>
            <p>Monitoramento de pre√ßos de combust√≠veis - Grupo Lisboa | √öltimos 7 dias</p>
        </div>

        <!-- Estat√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-label">Postos Ativos</div>
                <div class="stat-value">{{ total_postos }}</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">‚õΩ</div>
                <div class="stat-label">Produtos</div>
                <div class="stat-value">{{ total_produtos }}</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-label">Pre√ßos Coletados</div>
                <div class="stat-value">{{ total_precos }}</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">üïí</div>
                <div class="stat-label">√öltima Atualiza√ß√£o</div>
                <div class="stat-value" style="font-size: 18px;">
                    {% if ultima_atualizacao %}
                        {{ ultima_atualizacao|date:"d/m H:i" }}
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Pre√ßos -->
        <div class="table-container">
            <div class="table-header">
                <h2>üìä Matriz de Pre√ßos por Posto</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <!-- Navega√ß√£o entre datas -->
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <!-- Bot√£o Data Anterior -->
                        {% if data_anterior %}
                            <button onclick="navegarParaData('{{ data_anterior|date:"Y-m-d" }}')" 
                                    style="background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                ‚óÄÔ∏è
                            </button>
                        {% else %}
                            <button disabled 
                                    style="background: #cbd5e0; color: #a0aec0; border: none; padding: 10px 15px; border-radius: 8px; cursor: not-allowed; font-size: 16px;">
                                ‚óÄÔ∏è
                            </button>
                        {% endif %}
                        
                        <!-- Dropdown de datas -->
                        {% if datas_disponiveis %}
                            <select id="seletorData" class="date-selector" onchange="navegarParaData(this.value)" 
                                    style="padding: 10px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; min-width: 150px;">
                                {% for data in datas_disponiveis %}
                                    <option value="{{ data.data }}" {% if data.selected %}selected{% endif %}>
                                        üìÖ {{ data.label }}
                                        {% if forloop.first %}
                                            (Mais recente)
                                        {% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        {% endif %}
                        
                        <!-- Bot√£o Pr√≥xima Data -->
                        {% if data_proxima %}
                            <button onclick="navegarParaData('{{ data_proxima|date:"Y-m-d" }}')" 
                                    style="background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                ‚ñ∂Ô∏è
                            </button>
                        {% else %}
                            <button disabled 
                                    style="background: #cbd5e0; color: #a0aec0; border: none; padding: 10px 15px; border-radius: 8px; cursor: not-allowed; font-size: 16px;">
                                ‚ñ∂Ô∏è
                            </button>
                        {% endif %}
                    </div>
                    
                    <button class="btn-scraper" onclick="abrirModalScraper()">üîÑ Executar Scraper</button>
                    <button class="btn-refresh" onclick="window.location.reload()">üîÑ Atualizar</button>
                </div>
            </div>

            {% if matriz_precos %}
                <table>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            {% for posto in postos %}
                                <th class="posto-header">
                                    {{ posto.nome_fantasia }}
                                    <span class="posto-codigo">#{{ posto.codigo_vibra }}</span>
                                    {% if posto.ultima_coleta %}
                                        <span class="posto-data">{{ posto.ultima_coleta|date:"d/m H:i" }}</span>
                                    {% endif %}
                                </th>
                            {% endfor %}
                            <th style="text-align: center;">Varia√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for linha in matriz_precos %}
                            <tr>
                                <td>{{ linha.produto }}</td>
                                
                                {% for posto in postos %}
                                    <td style="text-align: center;">
                                        {% with preco_info=linha.postos|get_item:posto.cnpj %}
                                            {% if preco_info %}
                                                <div class="preco {{ preco_info.css_class }}">
                                                    R$ {{ preco_info.preco|floatformat:4 }}
                                                </div>
                                                {% if preco_info.prazo %}
                                                    <div class="prazo">{{ preco_info.prazo }}</div>
                                                {% endif %}
                                            {% else %}
                                                <span class="sem-preco">-</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                {% endfor %}
                                
                                <td style="text-align: center;">
                                    {% if linha.variacao_percentual > 0 %}
                                        <span class="variacao {% if linha.variacao_percentual < 2 %}variacao-baixa{% elif linha.variacao_percentual < 5 %}variacao-media{% else %}variacao-alta{% endif %}">
                                            {{ linha.variacao_percentual|floatformat:2 }}%
                                        </span>
                                    {% else %}
                                        <span class="sem-preco">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <h3>Nenhum dado dispon√≠vel</h3>
                    <p>Execute o scraper Vibra para coletar pre√ßos dos postos</p>
                    <br>
                    <button class="btn-refresh" onclick="alert('Execute: python fuel_prices/scrapers/vibra_scraper.py')">
                        ‚ñ∂Ô∏è Instru√ß√µes
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal Scraper -->
    <div id="modalScraper" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîÑ Executar Scraper Vibra</h2>
                <span class="close" onclick="fecharModalScraper()">&times;</span>
            </div>
            
            <p style="color: #718096; margin-bottom: 20px;">
                Selecione os postos para coletar pre√ßos:
            </p>
            
            <button class="select-all" onclick="selecionarTodos()">‚úì Selecionar Todos</button>
            
            <form id="formScraper">
                {% for posto in postos %}
                    <div class="posto-checkbox">
                        <input type="checkbox" name="postos" value="{{ posto.codigo_vibra }}" id="posto_{{ posto.codigo_vibra }}">
                        <label for="posto_{{ posto.codigo_vibra }}">
                            <strong>{{ posto.nome_fantasia }}</strong> - #{{ posto.codigo_vibra }}
                            <br>
                            <small style="color: #718096;">{{ posto.razao_social }}</small>
                        </label>
                    </div>
                {% endfor %}
            </form>
            
            <button class="btn-executar" onclick="executarScraper()">
                ‚ñ∂Ô∏è Executar Scraper
            </button>
            
            <div id="statusScraper" style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; display: none;">
                <p style="color: #2d3748; margin: 0;"></p>
            </div>
        </div>
    </div>

    <script>
        function abrirModalScraper() {
            document.getElementById('modalScraper').style.display = 'block';
        }

        function fecharModalScraper() {
            document.getElementById('modalScraper').style.display = 'none';
        }

        function selecionarTodos() {
            const checkboxes = document.querySelectorAll('input[name="postos"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        }

        function executarScraper() {
            const checkboxes = document.querySelectorAll('input[name="postos"]:checked');
            
            if (checkboxes.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos um posto!');
                return;
            }

            const postos = Array.from(checkboxes).map(cb => cb.value);
            const statusDiv = document.getElementById('statusScraper');
            const btnExecutar = document.querySelector('.btn-executar');
            
            console.log('Postos selecionados:', postos);
            
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #2d3748;">‚è≥ Iniciando scraper... Aguarde...</p>';
            btnExecutar.disabled = true;
            btnExecutar.textContent = '‚è≥ Executando...';

            const csrfToken = getCookie('csrftoken');
            console.log('CSRF Token:', csrfToken);

            fetch('/fuel/executar-scraper/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    postos: postos
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.status === 'iniciado') {
                    statusDiv.innerHTML = '<p style="color: #22c55e;">‚úÖ ' + data.message + '</p>';
                    setTimeout(() => {
                        fecharModalScraper();
                        window.location.reload();
                    }, 3000);
                } else {
                    statusDiv.innerHTML = '<p style="color: #ef4444;">‚ùå ' + (data.message || 'Erro desconhecido') + '</p>';
                    btnExecutar.disabled = false;
                    btnExecutar.textContent = '‚ñ∂Ô∏è Executar Scraper';
                }
            })
            .catch(error => {
                console.error('Erro completo:', error);
                statusDiv.innerHTML = '<p style="color: #ef4444;">‚ùå Erro ao executar scraper: ' + error.message + '</p>';
                btnExecutar.disabled = false;
                btnExecutar.textContent = '‚ñ∂Ô∏è Executar Scraper';
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Fun√ß√µes de navega√ß√£o hist√≥rica
        function navegarParaData(data) {
            if (data) {
                window.location.href = '?data=' + data;
            }
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalScraper');
            if (event.target === modal) {
                fecharModalScraper();
            }
        }
    </script>
</body>
</html>
