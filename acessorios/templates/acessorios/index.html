{% extends "base.html" %}
{% load static %}

{% block title %}Processador de Imagens - VerifiK{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-image"></i> Processador de Imagens
            </h1>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total de Imagens</h5>
                    <h2>{{ total_imagens }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Anotadas</h5>
                    <h2>{{ total_anotadas }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Não Anotadas</h5>
                    <h2>{{ total_nao_anotadas }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Processados</h5>
                    <h2>{{ processamentos_recentes|length }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão Grande de Processamento Direto -->
    <div class="row mb-4">
        <div class="col-12">
            <button id="btn-processar-tudo" class="btn btn-danger btn-lg btn-block" style="padding: 20px; font-size: 1.5em; font-weight: bold;">
                <i class="fas fa-rocket"></i> PROCESSAR TUDO DIRETO
            </button>
            <div id="resultado-tudo-direto" style="display:none; margin-top: 15px;">
                <p id="msg-tudo-direto"></p>
                <div class="alert alert-success" id="sucesso-tudo-direto" style="display:none;"></div>
                <div class="alert alert-danger" id="erro-tudo-direto" style="display:none;"></div>
            </div>
            <p class="text-center text-muted" id="aguarde-tudo-direto" style="display:none; margin-top: 15px;">
                <i class="fas fa-spinner fa-spin"></i> Processando todas as imagens... Por favor aguarde.
            </p>
        </div>
    </div>

    <!-- Abas -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#por-categoria">Por Categoria</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#por-marca">Por Marca</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#por-produtos">Vários Produtos</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#todas">Todas Não Anotadas</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#galeria">Galeria</a>
        </li>
    </ul>

    <!-- Conteúdo das Abas -->
    <div class="tab-content mt-4">
        <!-- Por Categoria -->
        <div id="por-categoria" class="tab-pane fade show active">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5>Processamento por Categoria</h5>
                        </div>
                        <div class="card-body">
                            <form id="form-categoria" method="post">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label>Selecione uma Categoria:</label>
                                    <select class="form-control" id="categoria_id" name="categoria_id" required>
                                        <option value="">-- Escolha uma categoria --</option>
                                        {% for cat in categorias %}
                                            <option value="{{ cat.id }}">{{ cat.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-play"></i> Processar Categoria
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5>Resultado</h5>
                        </div>
                        <div class="card-body">
                            <div id="resultado-categoria" style="display:none;">
                                <p id="msg-categoria"></p>
                                <div class="alert alert-success" id="sucesso-categoria" style="display:none;"></div>
                                <div class="alert alert-danger" id="erro-categoria" style="display:none;"></div>
                            </div>
                            <p class="text-muted" id="aguarde-categoria" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i> Processando... Por favor aguarde.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Por Marca -->
        <div id="por-marca" class="tab-pane fade">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5>Processamento por Marca</h5>
                        </div>
                        <div class="card-body">
                            <form id="form-marca" method="post">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label>Selecione uma Marca:</label>
                                    <select class="form-control" id="marca_id" name="marca_id" required>
                                        <option value="">-- Escolha uma marca --</option>
                                        {% for marca in marcas %}
                                            <option value="{{ marca.id }}">{{ marca.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-play"></i> Processar Marca
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5>Resultado</h5>
                        </div>
                        <div class="card-body">
                            <div id="resultado-marca" style="display:none;">
                                <p id="msg-marca"></p>
                                <div class="alert alert-success" id="sucesso-marca" style="display:none;"></div>
                                <div class="alert alert-danger" id="erro-marca" style="display:none;"></div>
                            </div>
                            <p class="text-muted" id="aguarde-marca" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i> Processando... Por favor aguarde.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vários Produtos -->
        <div id="por-produtos" class="tab-pane fade">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5>Processamento de Vários Produtos</h5>
                        </div>
                        <div class="card-body">
                            <form id="form-produtos" method="post">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label>Digite os IDs dos Produtos (separados por vírgula):</label>
                                    <input type="text" class="form-control" id="produtos_ids" name="produtos_ids" placeholder="Ex: 1,2,3,4,5" required>
                                    <small class="form-text text-muted">
                                        Processa TODAS as imagens relacionadas aos produtos selecionados.
                                    </small>
                                </div>
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-play"></i> Processar Produtos
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5>Resultado</h5>
                        </div>
                        <div class="card-body">
                            <div id="resultado-produtos" style="display:none;">
                                <p id="msg-produtos"></p>
                                <div class="alert alert-success" id="sucesso-produtos" style="display:none;"></div>
                                <div class="alert alert-danger" id="erro-produtos" style="display:none;"></div>
                            </div>
                            <p class="text-muted" id="aguarde-produtos" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i> Processando... Por favor aguarde.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Todas Não Anotadas -->
        <div id="todas" class="tab-pane fade">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5>Processar Todas as Imagens Não Anotadas</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                Total de imagens não anotadas: <strong>{{ total_nao_anotadas }}</strong>
                            </p>
                            <p class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Este processamento pode levar algum tempo dependendo do número de imagens.
                            </p>
                            <form id="form-todas" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-block btn-lg">
                                    <i class="fas fa-play"></i> Processar TODAS (Lote de 50)
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5>Resultado</h5>
                        </div>
                        <div class="card-body">
                            <div id="resultado-todas" style="display:none;">
                                <p id="msg-todas"></p>
                                <div class="alert alert-success" id="sucesso-todas" style="display:none;"></div>
                                <div class="alert alert-danger" id="erro-todas" style="display:none;"></div>
                            </div>
                            <p class="text-muted" id="aguarde-todas" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i> Processando... Por favor aguarde.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Galeria -->
        <div id="galeria" class="tab-pane fade">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5>Galeria de Imagens Processadas</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        <a href="{% url 'acessorios:galeria' %}" class="btn btn-success">
                            <i class="fas fa-images"></i> Ver Galeria Completa
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Processamentos Recentes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5>Processamentos Recentes</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Data</th>
                                <th>Imagem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for proc in processamentos_recentes %}
                            <tr>
                                <td><span class="badge badge-info">{{ proc.get_tipo_display }}</span></td>
                                <td>
                                    {% if proc.status == 'sucesso' %}
                                        <span class="badge badge-success">Sucesso</span>
                                    {% elif proc.status == 'erro' %}
                                        <span class="badge badge-danger">Erro</span>
                                    {% else %}
                                        <span class="badge badge-warning">{{ proc.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ proc.data_criacao|date:"d/m/Y H:i" }}</td>
                                <td>
                                    {% if proc.imagem_processada %}
                                        <a href="/media/{{ proc.imagem_processada }}" target="_blank" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i> Ver
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Botão PROCESSAR TUDO DIRETO
    $('#btn-processar-tudo').click(function(e) {
        e.preventDefault();
        
        if (!confirm('Tem certeza que deseja processar TODAS as imagens não anotadas? Isso pode levar alguns minutos...')) {
            return;
        }
        
        $('#btn-processar-tudo').prop('disabled', true);
        $('#aguarde-tudo-direto').show();
        $('#resultado-tudo-direto').hide();
        
        $.post('{% url "acessorios:processar_tudo_direto" %}', {
            'csrfmiddlewaretoken': $('[name="csrfmiddlewaretoken"]').val()
        }, function(data) {
            $('#aguarde-tudo-direto').hide();
            $('#resultado-tudo-direto').show();
            
            if (data.sucesso) {
                let msg = data.mensagem;
                if (data.restantes > 0) {
                    msg += '<br><br><button class="btn btn-warning mt-2" onclick="location.reload()">Processar Próximo Lote (' + data.restantes + ' imagens)</button>';
                }
                $('#sucesso-tudo-direto').show().html(msg);
                $('#erro-tudo-direto').hide();
            } else {
                $('#erro-tudo-direto').show().html(data.erro);
                $('#sucesso-tudo-direto').hide();
            }
            $('#msg-tudo-direto').html(`✅ Processados: ${data.total_processados} | ❌ Erros: ${data.total_erros}`);
        }).fail(function(err) {
            $('#aguarde-tudo-direto').hide();
            $('#resultado-tudo-direto').show();
            $('#erro-tudo-direto').show().html('❌ Erro ao processar: ' + (err.responseJSON?.erro || err.statusText));
        }).always(function() {
            $('#btn-processar-tudo').prop('disabled', false);
        });
    });

    // Processamento por Categoria
    $('#form-categoria').submit(function(e) {
        e.preventDefault();
        let categoria_id = $('#categoria_id').val();
        
        if (!categoria_id) {
            alert('Selecione uma categoria!');
            return;
        }
        
        $('#aguarde-categoria').show();
        $('#resultado-categoria').hide();
        
        $.post('{% url "acessorios:processar_categoria" %}', {
            'categoria_id': categoria_id,
            'csrfmiddlewaretoken': $('[name="csrfmiddlewaretoken"]').val()
        }, function(data) {
            $('#aguarde-categoria').hide();
            $('#resultado-categoria').show();
            
            if (data.sucesso) {
                $('#sucesso-categoria').show().html(data.mensagem);
                $('#erro-categoria').hide();
            } else {
                $('#erro-categoria').show().html(data.erro);
                $('#sucesso-categoria').hide();
            }
            $('#msg-categoria').html(`Processados: ${data.total_processados} | Erros: ${data.total_erros}`);
        }).fail(function(err) {
            $('#aguarde-categoria').hide();
            $('#resultado-categoria').show();
            $('#erro-categoria').show().html('Erro ao processar: ' + err.responseJSON.erro);
        });
    });

    // Processamento por Marca
    $('#form-marca').submit(function(e) {
        e.preventDefault();
        let marca_id = $('#marca_id').val();
        
        if (!marca_id) {
            alert('Selecione uma marca!');
            return;
        }
        
        $('#aguarde-marca').show();
        $('#resultado-marca').hide();
        
        $.post('{% url "acessorios:processar_marca" %}', {
            'marca_id': marca_id,
            'csrfmiddlewaretoken': $('[name="csrfmiddlewaretoken"]').val()
        }, function(data) {
            $('#aguarde-marca').hide();
            $('#resultado-marca').show();
            
            if (data.sucesso) {
                $('#sucesso-marca').show().html(data.mensagem);
                $('#erro-marca').hide();
            } else {
                $('#erro-marca').show().html(data.erro);
                $('#sucesso-marca').hide();
            }
            $('#msg-marca').html(`Processados: ${data.total_processados} | Erros: ${data.total_erros}`);
        }).fail(function(err) {
            $('#aguarde-marca').hide();
            $('#resultado-marca').show();
            $('#erro-marca').show().html('Erro ao processar: ' + err.responseJSON.erro);
        });
    });

    // Processamento de Todas
    $('#form-todas').submit(function(e) {
        e.preventDefault();
        
        $('#aguarde-todas').show();
        $('#resultado-todas').hide();
        
        $.post('{% url "acessorios:processar_todas" %}', {
            'csrfmiddlewaretoken': $('[name="csrfmiddlewaretoken"]').val()
        }, function(data) {
            $('#aguarde-todas').hide();
            $('#resultado-todas').show();
            
            if (data.sucesso) {
                let msg = data.mensagem;
                if (data.restantes > 0) {
                    msg += '<br><button class="btn btn-warning mt-2" onclick="location.reload()">Processar Próximo Lote</button>';
                }
                $('#sucesso-todas').show().html(msg);
                $('#erro-todas').hide();
            } else {
                $('#erro-todas').show().html(data.erro);
                $('#sucesso-todas').hide();
            }
            $('#msg-todas').html(`Processados: ${data.total_processados} | Erros: ${data.total_erros}`);
        }).fail(function(err) {
            $('#aguarde-todas').hide();
            $('#resultado-todas').show();
            $('#erro-todas').show().html('Erro ao processar: ' + err.responseJSON.erro);
        });
    });

    // Processamento de Vários Produtos
    $('#form-produtos').submit(function(e) {
        e.preventDefault();
        let produtos_ids = $('#produtos_ids').val().trim();
        
        if (!produtos_ids) {
            alert('Digite os IDs dos produtos!');
            return;
        }
        
        $('#aguarde-produtos').show();
        $('#resultado-produtos').hide();
        
        $.post('{% url "acessorios:processar_multiplos" %}', {
            'produtos_ids': produtos_ids,
            'csrfmiddlewaretoken': $('[name="csrfmiddlewaretoken"]').val()
        }, function(data) {
            $('#aguarde-produtos').hide();
            $('#resultado-produtos').show();
            
            if (data.sucesso) {
                let msg = data.mensagem;
                if (data.restantes > 0) {
                    msg += '<br><button class="btn btn-warning mt-2" onclick="location.reload()">Processar Próximo Lote</button>';
                }
                $('#sucesso-produtos').show().html(msg);
                $('#erro-produtos').hide();
            } else {
                $('#erro-produtos').show().html(data.erro);
                $('#sucesso-produtos').hide();
            }
            $('#msg-produtos').html(`Processados: ${data.total_processados} | Erros: ${data.total_erros}`);
        }).fail(function(err) {
            $('#aguarde-produtos').hide();
            $('#resultado-produtos').show();
            $('#erro-produtos').show().html('Erro ao processar: ' + (err.responseJSON?.erro || err.statusText));
        });
    });
});
</script>

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .nav-tabs .nav-link.active {
        font-weight: bold;
        border-bottom: 3px solid #007bff;
    }
</style>
{% endblock %}
